---
import BaseLayout from './BaseLayout.astro';
import ShareButtons from '../components/ShareButtons.astro';
import AdSense from '../components/AdSense.astro';
import SupportButtons from '../components/SupportButtons.astro';
import AmazonProduct from '../components/AmazonProduct.astro';
import BlogCTA from '../components/BlogCTA.astro';
import Icon from '../components/Icon.astro';
import type { IconName } from '../components/icons';

interface Props {
  frontmatter: {
    title: string;
    description: string;
    pubDate: string;
    updatedDate?: string;
    category?: string;
    tags?: string[];
    author?: string;
    noteUrl?: string;
    amazonProducts?: Array<{
      asin: string;
      title: string;
      image?: string;
      price?: string;
    }>;
  };
}

const { frontmatter } = Astro.props;
const {
  title,
  description,
  pubDate,
  updatedDate,
  category = 'dev-tips',
  tags = [],
  author = 'secure＆autoラボ',
  noteUrl,
  amazonProducts = [],
} = frontmatter;

const categoryMeta: Record<string, { label: string; icon: IconName; gradient: string }> = {
  automation: { label: '自動化', icon: 'zap', gradient: 'from-amber-500 to-orange-600' },
  ai: { label: 'AI', icon: 'bot', gradient: 'from-violet-500 to-purple-600' },
  security: { label: 'セキュリティ', icon: 'lock', gradient: 'from-emerald-500 to-teal-600' },
  'dev-tips': { label: 'Tips', icon: 'lightbulb', gradient: 'from-cyan-500 to-blue-600' },
  projects: { label: 'プロジェクト', icon: 'rocket', gradient: 'from-pink-500 to-rose-600' },
  web: { label: 'Web', icon: 'globe', gradient: 'from-blue-500 to-indigo-600' },
  infrastructure: { label: 'インフラ', icon: 'building2', gradient: 'from-slate-500 to-zinc-600' },
};

const formatDate = (dateStr: string) => {
  const date = new Date(dateStr);
  return date.toLocaleDateString('ja-JP', { year: 'numeric', month: 'long', day: 'numeric' });
};

const jsonLd = {
  '@context': 'https://schema.org',
  '@type': 'TechArticle',
  headline: title,
  description: description,
  author: { '@type': 'Person', name: author },
  datePublished: pubDate,
  dateModified: updatedDate || pubDate,
  publisher: {
    '@type': 'Organization',
    name: 'Secure Auto Lab',
    url: 'https://blog.secure-auto-lab.com',
  },
};

const meta = categoryMeta[category] || categoryMeta['dev-tips'];

const ctaVariantMap: Record<string, 'automation' | 'security' | 'appdev' | 'general'> = {
  automation: 'automation',
  ai: 'automation',
  security: 'security',
  'dev-tips': 'general',
  projects: 'appdev',
  web: 'appdev',
  infrastructure: 'general',
};
const ctaVariant = ctaVariantMap[category] || 'general';
---

<BaseLayout title={`${title} | Secure Auto Lab`} description={description}>
  <script type="application/ld+json" set:html={JSON.stringify(jsonLd)} />

  <!-- Back link -->
  <a
    href="/articles"
    class="inline-flex items-center gap-2 text-sm text-dark-400 hover:text-white mb-8 transition-colors"
  >
    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"/>
    </svg>
    記事一覧に戻る
  </a>

  <article class="max-w-3xl mx-auto">
    <!-- Header -->
    <header class="mb-12">
      <div class="flex items-center gap-3 mb-6">
        <a
          href={`/category/${category}`}
          class={`inline-flex items-center gap-1.5 px-3 py-1.5 text-sm rounded-full bg-gradient-to-r ${meta.gradient} text-white hover:shadow-lg hover:shadow-${category === 'ai' ? 'purple' : 'cyan'}-500/25 transition-all`}
        >
          <Icon name={meta.icon} size={16} />
          {meta.label}
        </a>
        <span class="text-dark-500">•</span>
        <time class="text-sm text-dark-400" datetime={pubDate}>
          {formatDate(pubDate)}
        </time>
      </div>

      <h1 class="text-heading-1 font-bold text-white mb-6 leading-tight">
        {title}
      </h1>

      <p class="text-xl text-dark-300 leading-relaxed mb-6">
        {description}
      </p>

      {tags.length > 0 && (
        <div class="flex flex-wrap gap-2">
          {tags.map((tag) => (
            <a
              href={`/tags/${tag}`}
              class="px-3 py-1 text-sm text-dark-400 bg-white/5 hover:bg-white/10 rounded-full border border-white/5 hover:border-white/10 transition-all"
            >
              #{tag}
            </a>
          ))}
        </div>
      )}

      {updatedDate && (
        <p class="mt-4 text-sm text-dark-500">
          最終更新: <time datetime={updatedDate}>{formatDate(updatedDate)}</time>
        </p>
      )}
    </header>

    <!-- Ad before content -->
    <AdSense slot="article-top" />

    <!-- Article content -->
    <div class="prose prose-lg prose-invert max-w-none">
      <slot />
    </div>

    <!-- Blog → B2B CTA -->
    <div class="my-12">
      <BlogCTA variant={ctaVariant} />
    </div>

    <!-- Note CTA -->
    {noteUrl && (
      <div class="my-12 relative overflow-hidden rounded-2xl">
        <div class="absolute inset-0 bg-gradient-to-br from-green-500/20 to-emerald-600/20"></div>
        <div class="absolute inset-0 bg-dark-900/80 backdrop-blur-xl"></div>
        <div class="absolute inset-0 border border-green-500/20 rounded-2xl"></div>

        <div class="relative p-8">
          <div class="flex items-start gap-4">
            <div class="flex-shrink-0 w-12 h-12 rounded-xl bg-gradient-to-br from-green-500 to-emerald-600 flex items-center justify-center">
              <Icon name="bookOpen" size={24} class="text-white" />
            </div>
            <div class="flex-1">
              <h3 class="text-lg font-bold text-white mb-2">
                この記事の完全版を読む
              </h3>
              <p class="text-dark-300 mb-4">
                より詳細な解説・完全なソースコード・追加のTipsをNoteで公開しています。
              </p>
              <a
                href={noteUrl}
                target="_blank"
                rel="noopener"
                class="inline-flex items-center gap-2 px-6 py-3 bg-gradient-to-r from-green-500 to-emerald-600 text-white font-medium rounded-xl hover:shadow-lg hover:shadow-green-500/25 transition-all"
              >
                Noteで読む
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14"/>
                </svg>
              </a>
            </div>
          </div>
        </div>
      </div>
    )}

    <!-- Amazon Products -->
    {amazonProducts.length > 0 && (
      <div class="my-12">
        <h3 class="text-lg font-bold text-white mb-6 flex items-center gap-2">
          <Icon name="shoppingCart" size={22} class="text-white" />
          関連商品
        </h3>
        <div class="space-y-4">
          {amazonProducts.map((product) => (
            <AmazonProduct {...product} />
          ))}
        </div>
      </div>
    )}

    <!-- Ad after content -->
    <AdSense slot="article-bottom" />

    <!-- Share & Support -->
    <div class="mt-16 pt-8 border-t border-white/10">
      <div class="grid md:grid-cols-2 gap-8">
        <div>
          <h3 class="text-lg font-bold text-white mb-4 flex items-center gap-2">
            <Icon name="share2" size={20} /> この記事をシェア
          </h3>
          <ShareButtons title={title} url={Astro.url.href} />
        </div>
        <div>
          <h3 class="text-lg font-bold text-white mb-4 flex items-center gap-2">
            <Icon name="heart" size={20} class="text-accent-pink" /> 著者を支援
          </h3>
          <SupportButtons />
        </div>
      </div>
    </div>

    <!-- Author -->
    <div class="mt-12 p-6 rounded-2xl bg-white/[0.02] border border-white/5">
      <div class="flex items-center gap-4">
        <div class="w-16 h-16 rounded-full bg-gradient-to-br from-accent-cyan to-accent-purple flex items-center justify-center text-white">
          <Icon name="code" size={28} />
        </div>
        <div>
          <p class="font-medium text-white">{author}</p>
          <p class="text-sm text-dark-400">
            情報処理安全確保支援士とPMの資格を使ってITコンサルタントとして働く傍ら、自宅で自動化とセキュリティを研究しているエンジニア
          </p>
        </div>
      </div>
    </div>
  </article>
</BaseLayout>

<style>
  /* Article content styles */
  .prose :global(h2) {
    @apply mt-12 mb-6 text-2xl font-bold text-white border-b border-white/10 pb-4;
  }

  .prose :global(h3) {
    @apply mt-8 mb-4 text-xl font-semibold text-white;
  }

  .prose :global(p) {
    @apply text-dark-300 leading-relaxed;
  }

  .prose :global(a) {
    @apply text-accent-cyan hover:text-accent-purple transition-colors;
  }

  .prose :global(ul), .prose :global(ol) {
    @apply text-dark-300;
  }

  .prose :global(li::marker) {
    @apply text-accent-cyan;
  }

  .prose :global(pre) {
    @apply bg-dark-900 border border-white/10 rounded-xl;
  }

  .prose :global(code) {
    @apply text-accent-cyan bg-accent-cyan/10 px-2 py-0.5 rounded-md text-sm;
  }

  .prose :global(pre code) {
    @apply bg-transparent p-0;
  }

  .prose :global(blockquote) {
    @apply border-l-4 border-accent-purple bg-accent-purple/5 rounded-r-xl px-6 py-4 text-dark-300 italic;
  }

  .prose :global(img) {
    @apply rounded-xl border border-white/10;
  }

  .prose :global(table) {
    @apply w-full border-collapse;
  }

  .prose :global(th) {
    @apply bg-white/5 text-white font-semibold text-left px-4 py-3 border-b border-white/10;
  }

  .prose :global(td) {
    @apply px-4 py-3 border-b border-white/5 text-dark-300;
  }

  .prose :global(tr:hover td) {
    @apply bg-white/[0.02];
  }
</style>
